import fs from "fs";
import path from "path";

const LICENSES_JSON = "licenses.json";
const OUTPUT_FILE = "thirdPartyLicenses.ts";

const data = JSON.parse(fs.readFileSync(LICENSES_JSON, "utf8"));

function readFirstExistingFile(baseDir, files) {
    for (const f of files) {
        const p = path.join(baseDir, f);
        if (fs.existsSync(p) && fs.statSync(p).isFile()) {
            return fs.readFileSync(p, "utf8");
        }
    }
    return null;
}

const LICENSE_FILENAMES = [
    "LICENSE",
    "LICENSE.md",
    "LICENSE.txt",
    "LICENCE",
    "COPYING",
    "NOTICE",
];

function escapeForTemplateLiteral(text) {
    return text
        .replace(/\\/g, "\\\\")
        .replace(/`/g, "\\`")
        .replace(/\$\{/g, "\\${");
}

function flowTextPreserveParagraphs(text) {
    // Normalize newlines and preserve paragraphs (blank lines) while removing
    // hard line-breaks inside paragraphs so the text wraps naturally in UI.
    const normalized = String(text).replace(/\r\n/g, "\n").replace(/\r/g, "\n");

    const paragraphs = normalized
        .split(/\n{2,}/)
        .map(p => p
            .replace(/\n+/g, " ")
            .replace(/\s{2,}/g, " ")
            .trim()
        )
        .filter(Boolean);

    return paragraphs.join("\n\n");
}

let body = `Third-Party Licenses\n\n`;

for (const [pkgKey, info] of Object.entries(data).sort(([a], [b]) => a.localeCompare(b))) {
    const name = pkgKey;
    const license = info.licenses ?? "UNKNOWN";
    const repo = info.repository ?? "";
    const licenseFile = info.licenseFile;
    let licenseText = null;

    if (licenseFile && fs.existsSync(licenseFile)) {
        licenseText = fs.readFileSync(licenseFile, "utf8");
    } else if (info.path) {
        licenseText = readFirstExistingFile(info.path, LICENSE_FILENAMES);
    }

    if (!licenseText) {
        licenseText = `License text not found.\nType: ${license}\n${repo}`;
    }

    body += "──────────────────────────\n";
    body += `${name}\n`;
    body += `${license}\n`;
    if (repo) body += `${repo}\n`;
    body += "";
    body += flowTextPreserveParagraphs(licenseText).trimEnd() + "\n\n";
}

const output = `/* 
AUTO-GENERATED FILE — DO NOT EDIT
Generated by scripts/build-licenses.mjs
*/

const THIRD_PARTY_LICENSES = \`
${escapeForTemplateLiteral(body)}
\`;

export default THIRD_PARTY_LICENSES;
`;

fs.mkdirSync(path.dirname(OUTPUT_FILE), { recursive: true });
fs.writeFileSync(OUTPUT_FILE, output, "utf8");

console.log(`Wrote ${OUTPUT_FILE}`);
